<%

 bt_name   = @presenter_obj.client_token.name;
 bt_symbol = @presenter_obj.client_token.symbol;

 fiat_symbol = @presenter_obj.client_fiat_curreny_pref_symbol;
 fiat_type   = @presenter_obj.client_fiat_curreny_symbol;
 fiat_display_text = @presenter_obj.client_fiat_curreny_display_text;

 client_token_planner = @presenter_obj.client_token_planner;


  ost_to_bt_input_name = "ost_to_bt"
  bt_to_mint_input_name = "bt_to_mint"

  ost_to_fiat = @presenter_obj.oracle_price_points.to_fiat_conversion_factor(fiat_type);
  if @presenter_obj.client_token.conversion_factor
    ost_to_bt = @presenter_obj.client_token.conversion_factor
    bt_to_ost = (1 / ost_to_bt).round(5)
    bt_to_fiat = ""
  elsif @presenter_obj.client_token_planner.present?
    bt_to_fiat = @presenter_obj.client_token_planner.token_worth_in_usd
    ost_to_bt = (ost_to_fiat / bt_to_fiat).round(5)
    bt_to_ost = (bt_to_fiat / ost_to_fiat).round(5)
  end

  if @presenter_obj.client_balances.present? && @presenter_obj.client_balances.ost_balance.present?
    user_ost_balance = @presenter_obj.client_balances.ost_balance
  else
    user_ost_balance = 0
  end

  number_of_users = client_token_planner.default_initial_users;
  airdrop_amount = client_token_planner.airdrop_bt_per_user;
  buffer_mint_factor_over_airdrop = client_token_planner.buffer_mint_factor_over_airdrop;

  min_bt_to_mint = number_of_users * airdrop_amount * 2;

  min_ost_needed_to_mint_bt = min_bt_to_mint / ost_to_bt

  show_error_modal = min_ost_needed_to_mint_bt > user_ost_balance

  bt_to_mint = number_of_users * airdrop_amount * buffer_mint_factor_over_airdrop;

  min_st_prime_to_mint = 100;
  st_prime_to_mint = 300;
  max_st_prime_to_mint = 500;

  # Note: I would avoid reducing max limit as the slider value changes.
  # Instead discuss with frankie how he would like to compute max_bt_to_mint.
  # The problem needs to be solved by reserving part of OST for bt minting & and some other part for st prime minting.
  max_ost_required_for_bt_minting = user_ost_balance - max_st_prime_to_mint;
  max_bt_to_mint = (max_ost_required_for_bt_minting * ost_to_bt).to_i;
  min_bt_to_mint = max_bt_to_mint if min_bt_to_mint > max_bt_to_mint

  value_in_fiat_key = "value_in_" + fiat_type;
  value_in_fiat_sym = value_in_fiat_key.to_sym;

  tx_kind_count = @presenter_obj.client_stats.transaction_kind_count

%>

<% content_for :end_js do %>
  <script type="text/javascript">
    $( function () {
      //Do PriceOracle Stuff First.
      window.PriceOracle && PriceOracle.setOstToBtFromErb( "<%= ost_to_bt %>" );
    });
    console.log("@presenter_obj.client_token", <%= raw @presenter_obj.client_token.to_json %>);
  </script>
<% end %>

<form id="step3_stake_and_mint_form" 
  action="/api/economy/token/stake-and-mint"  method="POST"
  class="form-container user-form" data-ost-formhelper>

  <div class="container">
    <div class="row">
      <div class="col-12 pt-6">
        <h3 class="text-center font-weight-bold letter-space-1">Plan the <%= bt_name %> Economy in 3 Easy Steps</h3>
        <%= render partial: 'shared/web/common/steps',
                   locals: {
                           classes_step_1: 'complete',
                           classes_step_2: 'complete',
                           classes_step_3: 'active'
                   }
        %>

        <div class="row">
          <div class="col-12">
            <div class="alert alert-info pt-4 mb-5" role="alert">
              <h5>
                <svg class="icon-card-transactions align-middle">
                  <switch>
                    <use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="#icon-card-transactions-3"></use>
                  </switch>
                </svg>
                The third step is minting <%= bt_symbol %>
                <a href="//help.ost.com/support/solutions/articles/35000059261-what-does-staking-and-minting-mean"
                   target="_blank" class="card-link float-right text-uppercase hover-link">Learn More
                </a>
              </h5>
              <hr class="mt-3 mb-4"/>
              <p class="font-weight-light font-size-p">Here you will select the number of <%= bt_symbol %> to mint. Based on your settings, the minimum amount of <%= bt_symbol %> required to mint is
                <span class="font-weight-bold"><%= number_with_delimiter(min_bt_to_mint, :delimiter => ',') %> <%#= bt_symbol %></span>.
              </p>
              <p class="font-weight-light font-size-p">
                An equivalent value of <%= ost_currency_symbol %> will be staked automatically at
                  <span class="font-weight-bold d-none"><%= ost_to_bt %> <%= bt_symbol %> = 1 <%= ost_currency_symbol %></span>
                  <span class="font-weight-bold">1 <%= bt_symbol %> = <%= bt_to_ost %> <%= ost_currency_symbol %></span>
              </p>
              <p class="font-weight-light font-size-p">You will need to reserve a minimum of <%= min_st_prime_to_mint %> <%= ost_currency_symbol %> to pay "gas" for <%= bt_symbol %> transaction by your users. <%= min_st_prime_to_mint %> OST‚ç∫ is enough gas reserve for approximately <span class="font-weight-bold">150,000 transfers</span>.</p>
            </div>
          </div>
        </div>

        <div class="card card-planner mb-5">
          <div class="card-header">
            <h3 class="mb-0">Mint Tokens</h3>
          </div>
          <div class="card-body pb-2">
            <div class="user-form">
              <%= render :partial => "web/economy/token_supply/mint_bt_widget",
                :locals => {
                  :ost_to_bt_input_name => ost_to_bt_input_name,
                  :bt_to_mint_input_name => bt_to_mint_input_name,
                  :stake_and_mint_form_id => "step3_stake_and_mint_form",
                  :bt_to_mint => bt_to_mint,
                  :min_bt_to_mint => min_bt_to_mint,
                  :max_bt_to_mint => max_bt_to_mint,
                  :min_st_prime_to_mint => min_st_prime_to_mint,
                  :max_st_prime_to_mint => max_st_prime_to_mint,
                  :bt_to_fiat => bt_to_fiat,
                  :st_prime_to_mint => st_prime_to_mint
                }
              %>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item font-weight-light font-size-p">
                <div class="d-flex align-items-center">
                  <div class="mr-2">
                    Based on the current value of <%= ost_currency_symbol %> you will set a conversion rate of
                    <strong class="font-weight-bold">
                      <span class="d-none"><%= ost_to_bt %> <%= bt_symbol %> = 1 <%= ost_currency_symbol %></span>
                      <span>1 <%= bt_symbol %> = <%= bt_to_ost %> <%= ost_currency_symbol %></span>
                    </strong>
                  </div>
                  <div class="mr-auto text-uppercase">
                    <a href="/planner/step-1" class="card-link float-right text-uppercase">Edit</a>
                  </div>
                </div>
              </li>
              <li class="list-group-item font-weight-light font-size-p">
                <div class="d-flex align-items-center">
                  <div class="mr-2"><strong class="font-weight-bold"><%= tx_kind_count %></strong> Actions set up.</div>
                  <div class="mr-auto text-uppercase">
                    <a href="/planner/step-2" class="card-link float-right text-uppercase">Edit</a>
                  </div>
                </div>
              </li>
              <li class="list-group-item font-weight-light font-size-p">
                <strong class="font-weight-bold"><%= number_of_users %> users</strong> will be automatically created. More can be added later.
                <input type="hidden" name="number_of_users" id="number_of_users" value="<%= number_of_users %>" />
              </li>
              <li class="list-group-item font-weight-light font-size-p border-bottom-0">
                In order to enable the transactions simulation
                <strong>
                  <%= airdrop_amount %> <%= bt_symbol %>
                </strong>
                will be initially distributed to each user.
                <input type="hidden" name="amount" id="airdrop_amount" value="<%= airdrop_amount %>" />
              </li>
              <input type="hidden" name="airdrop_user_list_type" id="airdrop_user_list_type" value="all" />
            </ul>
          </div>
        </div>
      </div>
    </div>

    <%=
        render :partial => "shared/web/common/faqs",
         locals: {
           header: "FAQ",
           faqs: [
              {
                title: 'What does Staking and Minting mean?',
                url: 'https://help.ost.com/support/solutions/articles/35000059261-what-does-staking-and-minting-mean-'
              },
              {
                title: 'What is Gas? and Who pays for it?',
                url: 'https://help.ost.com/support/solutions/articles/35000059262-what-is-gas-and-who-pays-for-it-'
              },
              {
                title: 'How do I Unstake?',
                url: 'https://help.ost.com/support/solutions/articles/35000059273-how-do-i-unstake-'
              }
           ]
         }
    %>

  </div>

  <footer>
    <div class="row sticky-footer">
      <div class="container">
        <a href="/planner/step-2" class="btn btn-steps-nav pt-3 pb-3 float-left text-left">&lt; SET UP ACTIONS</a>
        <button type="submit" id="mint_tokens_btn" href="javascript:void(0)" class="btn btn-steps-nav bg-yellow pt-3 pb-3 float-right">Mint Tokens &gt;</button>
      </div>
    </div>
    <div class="pseudo-footer"></div>
  </footer>
</form>

<% content_for :end_js do %>

    <script type="text/javascript">
      $( function () {
        //Do PriceOracle Stuff First.
        ost.planner_3.init({
          idMintTokens : "mint_tokens_btn",
          "bt_to_fiat" : "<%= bt_to_fiat %>"
        });
      });
      console.log("@presenter_obj.client_token", <%= raw @presenter_obj.client_token.to_json %>);
    </script>

    <% if show_error_modal %>
      <script type="text/javascript">
        $( function () {
          ost.mintBtWidget.showProcessFailureErrorCover();
        });
      </script>
    <% end %>

<% end %>