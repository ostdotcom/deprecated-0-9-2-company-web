<%

 bt_name   = @presenter_obj.client_token.name;
 bt_symbol = @presenter_obj.client_token.symbol;

 fiat_symbol = @presenter_obj.client_fiat_curreny_pref_symbol;
 fiat_type   = @presenter_obj.client_fiat_curreny_symbol;
 fiat_display_text = @presenter_obj.client_fiat_curreny_display_text;

 client_token_planner = @presenter_obj.client_token_planner;


  ost_to_bt_input_name = "conversion_factor"
  bt_to_mint_input_name = "bt_to_mint"

  ost_to_fiat = @presenter_obj.oracle_price_points.to_fiat_conversion_factor(fiat_type);
  if @presenter_obj.client_token.conversion_factor
    ost_to_bt = @presenter_obj.client_token.conversion_factor
    bt_to_fiat = ""
  elsif @presenter_obj.client_token_planner.present?
    bt_to_fiat = @presenter_obj.client_token_planner.token_worth_in_usd
    ost_to_bt = ost_to_fiat / bt_to_fiat
  end

  if @presenter_obj.client_balances.present? && @presenter_obj.client_balances.ost_balance.present?
    user_ost_balance = @presenter_obj.client_balances.ost_balance
  else
    user_ost_balance = 0
  end

  number_of_users = client_token_planner.default_initial_users;
  airdrop_amount = client_token_planner.airdrop_bt_per_user;
  buffer_mint_factor_over_airdrop = client_token_planner.buffer_mint_factor_over_airdrop;

  min_bt_to_mint = number_of_users * airdrop_amount;
  bt_to_mint = number_of_users * airdrop_amount * buffer_mint_factor_over_airdrop;

  min_st_prime_to_mint = 30;
  max_st_prime_to_mint = 100;

  # Note: I would avoid reducing max limit as the slider value changes.
  # Instead discuss with frankie how he would like to compute max_bt_to_mint.
  # The problem needs to be solved by reserving part of OST for bt minting & and some other part for st prime minting.
  max_ost_required_for_bt_minting = user_ost_balance - max_st_prime_to_mint;
  max_bt_to_mint = (max_ost_required_for_bt_minting * ost_to_bt).to_i;

  value_in_fiat_key = "value_in_" + fiat_type;
  value_in_fiat_sym = value_in_fiat_key.to_sym;

%>

<% content_for :end_js do %>
  <script type="text/javascript">
    $( function () {
      //Do PriceOracle Stuff First.
      window.PriceOracle && PriceOracle.setOstToBtFromErb( "<%= ost_to_bt %>" );
    });
    console.log("@presenter_obj.client_token", <%= raw @presenter_obj.client_token.to_json %>);
  </script>
<% end %>

<form id="step3_stake_and_mint_form" 
  action="/api/economy/token/stake-and-mint"  method="POST"
  class="form-container user-form" data-ost-formhelper>

  <div class="container">
    <div class="row">
      <div class="col-12">
        <h3 class="text-center mt-4">Plan the <%= bt_name %> Economy in 3 Easy Steps</h3>
        <%= render partial: 'shared/web/common/steps',
                   locals: {
                           classes_step_1: '',
                           classes_step_2: 'complete',
                           classes_step_3: 'active'
                   }
        %>

        <div class="card card-planner mb-5">
          <div class="card-header">
            <div class="d-flex align-items-center">
              <div class="mr-auto">
                <h3 class="card-title mb-1">Mint Tokens</h3>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="user-form">
              <%= render :partial => "web/economy/token_supply/mint_bt_widget",
                :locals => {
                  :ost_to_bt_input_name => ost_to_bt_input_name,
                  :bt_to_mint_input_name => bt_to_mint_input_name,
                  :stake_and_mint_form_id => "step3_stake_and_mint_form",
                  :bt_to_mint => bt_to_mint,
                  :min_bt_to_mint => min_bt_to_mint,
                  :max_bt_to_mint => max_bt_to_mint,
                  :min_st_prime_to_mint => min_st_prime_to_mint,
                  :max_st_prime_to_mint => max_st_prime_to_mint,
                  :bt_to_fiat => bt_to_fiat
                }
              %>
            </div>
            <ul class="list-group list-group-flush">
              <li class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="mr-2">
                    Based on the current value of OST⍺ you will set a conversion rate of
                    <strong>
                      <span id="ost_to_bt_text"><%= ost_to_bt %> FC = 1 OST</span>⍺
                    </strong>
                  </div>
                  <div class="mr-auto text-uppercase">
                    <a href="/planner/step-1">Edit</a>
                  </div>
                </div>
              </li>
              <li class="list-group-item">
                <div class="d-flex align-items-center">
                  <div class="mr-2"><strong>5</strong> Transaction Types Set Up.</div>
                  <div class="mr-auto text-uppercase">
                    <a href="/planner/step-2">Edit</a>
                  </div>
                </div>
              </li>
              <li class="list-group-item">
                Initially <strong><%= number_of_users %></strong> users will be automatically created for the simulation and more can be added later.
                <input type="hidden" name="number_of_users" id="number_of_users" value="<%= number_of_users %>" />
              </li>
              <li class="list-group-item">
                In order to enable the transactions simulation
                <strong>
                  <%= airdrop_amount %> <%= bt_symbol %>
                </strong>
                will be initially distributed to each user.
                <input type="hidden" name="airdrop_amount" id="airdrop_amount" value="<%= airdrop_amount %>" />
              </li>
              <li class="list-group-item">
                The minimum amount of tokens required to be minted is
                <strong><%= min_bt_to_mint %> <%= bt_symbol %></strong>.
                <input type="hidden" name="min_bt_to_mint" id="min_bt_to_mint" value="<%= min_bt_to_mint %>" />
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <%= render :partial => "shared/web/common/faqs" %>

  </div>

  <div class="row" style="background: #d9a025;">
    <div class="container">
      <a href="/planner/step-2" class="btn btn-steps-nav pt-3 pb-3 float-left text-left">&lt; Transactions</a>
      <button type="submit" id="mint_tokens_btn" href="javascript:void(0)" class="btn btn-steps-nav bg-yellow pt-3 pb-3 float-right">Mint coins &gt;</button>
    </div>
  </div>
</form>

<% content_for :end_js do %>
    <script type="text/javascript">
      $( function () {
        //Do PriceOracle Stuff First.
        ost.planner_3.init({
          idMintTokens : "mint_tokens_btn",
          "bt_to_fiat" : "<%= bt_to_fiat %>"
        });
      });
      console.log("@presenter_obj.client_token", <%= raw @presenter_obj.client_token.to_json %>);
    </script>
<% end %>